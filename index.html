<!doctype html>
<html lang="fr">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>League Planner V3 - Nexus</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-analytics-compat.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Beaufort+for+LOL:wght@400;700;800&family=Spiegel:wght@400;600&display=swap');

    :root {
      /* Premium LoL Hextech Theme Colors */
      --hex-blue-dark: #010A13;
      /* Very deep dark for true contrast */
      --hex-blue-panel: rgba(10, 20, 40, 0.75);
      /* More transparent for glass effect */
      --hex-gold-dark: #C89B3C;
      --hex-gold-light: #F0E6D2;
      --hex-cyan: #0AC8B9;
      --hex-cyan-glow: rgba(10, 200, 185, 0.4);
      --hex-red: #E84057;
      --hex-red-glow: rgba(232, 64, 87, 0.3);
      --hex-green: #00FF99;
      --hex-border: rgba(200, 155, 60, 0.3);
      /* Subtle gold border */
      --text-main: #F0E6D2;
      --text-muted: #8E929E;

      --shadow-soft: 0 4px 15px rgba(0, 0, 0, 0.5);
      --shadow-glow: 0 0 20px rgba(200, 155, 60, 0.15);
      --r: 12px;
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      font-family: 'Spiegel', sans-serif;
      color: var(--text-main);
      background-color: var(--hex-blue-dark);
      /* Premium multi-layered background */
      background-image:
        radial-gradient(circle at 15% 50%, rgba(10, 200, 185, 0.08), transparent 30%),
        radial-gradient(circle at 85% 15%, rgba(200, 155, 60, 0.05), transparent 40%),
        linear-gradient(to bottom, rgba(1, 10, 19, 0.9), rgba(1, 10, 19, 1)),
        url('data:image/svg+xml;utf8,<svg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"><path d="M0 0 L60 60 M60 0 L0 60" stroke="rgba(200,155,60,0.015)" stroke-width="1"/></svg>');
      background-size: cover, cover, cover, 60px 60px;
      background-attachment: fixed;
      overflow-x: hidden;
      scroll-behavior: smooth;
    }

    h1,
    h2,
    h3,
    h4 {
      font-family: 'Beaufort for LOL', serif;
      font-weight: 800;
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 1.5px;
    }

    /* Top Navigation bar */
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 40px;
      background: rgba(1, 10, 19, 0.65);
      border-bottom: 1px solid rgba(200, 155, 60, 0.2);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .brand h1 {
      color: var(--hex-gold-light);
      font-size: 26px;
      text-shadow: 0 0 15px rgba(200, 155, 60, 0.4);
      background: linear-gradient(to right, var(--hex-gold-light), var(--hex-gold-dark));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .nav-links {
      display: flex;
      gap: 25px;
    }

    .nav-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      font-family: 'Beaufort for LOL', serif;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 2px;
      padding: 10px 5px;
      transition: var(--transition);
      position: relative;
    }

    .nav-btn::after {
      content: '';
      position: absolute;
      bottom: -16px;
      /* Align with navbar border */
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 3px;
      background: var(--hex-gold-dark);
      box-shadow: 0 -2px 10px rgba(200, 155, 60, 0.5);
      transition: width 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    .nav-btn:hover {
      color: var(--hex-gold-light);
    }

    .nav-btn:hover::after,
    .nav-btn.active::after {
      width: 100%;
    }

    .nav-btn.active {
      color: var(--hex-gold-light);
      text-shadow: 0 0 10px rgba(200, 155, 60, 0.3);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .credits-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(10, 200, 185, 0.05);
      border: 1px solid rgba(10, 200, 185, 0.3);
      padding: 6px 16px;
      border-radius: 20px;
      /* Pill shape */
      color: var(--hex-cyan);
      font-weight: 600;
      box-shadow: inset 0 0 15px rgba(10, 200, 185, 0.05), 0 0 10px rgba(10, 200, 185, 0.1);
      transition: var(--transition);
    }

    .credits-badge:hover {
      border-color: var(--hex-cyan);
      box-shadow: inset 0 0 15px rgba(10, 200, 185, 0.1), 0 0 15px rgba(10, 200, 185, 0.2);
    }

    /* Main Container */
    .container {
      max-width: 1400px;
      margin: 40px auto;
      padding: 0 30px;
    }

    .section {
      display: none;
      animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      opacity: 0;
      transform: translateY(20px);
    }

    .section.active {
      display: block;
    }

    @keyframes slideUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Premium Cards */
    .card {
      background: var(--hex-blue-panel);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--hex-border);
      border-radius: var(--r);
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: var(--shadow-soft), var(--shadow-glow);
      position: relative;
    }

    .card-title {
      color: var(--hex-gold-light);
      font-size: 20px;
      margin-bottom: 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(200, 155, 60, 0.15);
      padding-bottom: 15px;
    }

    /* Matches Grid */
    .matches-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
      gap: 30px;
    }

    /* Ultra Premium Match Card */
    .match-card {
      background: linear-gradient(145deg, rgba(16, 25, 45, 0.8), rgba(5, 10, 20, 0.95));
      border: 1px solid rgba(200, 155, 60, 0.15);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
      transition: var(--transition);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    /* Hover effect */
    .match-card:hover {
      transform: translateY(-5px) scale(1.01);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.7), 0 0 15px rgba(200, 155, 60, 0.15);
      border-color: rgba(200, 155, 60, 0.4);
    }

    /* Winner Glow State */
    .match-card.finished-A {
      border-color: rgba(10, 200, 185, 0.4);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), 0 0 20px rgba(10, 200, 185, 0.05);
    }

    .match-card.finished-A:hover {
      border-color: var(--hex-cyan);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.7), 0 0 25px rgba(10, 200, 185, 0.15);
    }

    .match-card.finished-B {
      border-color: rgba(232, 64, 87, 0.4);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), 0 0 20px rgba(232, 64, 87, 0.05);
    }

    .match-card.finished-B:hover {
      border-color: var(--hex-red);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.7), 0 0 25px rgba(232, 64, 87, 0.15);
    }

    .match-header {
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      background: rgba(0, 0, 0, 0.3);
      border-bottom: 1px solid rgba(255, 255, 255, 0.03);
    }

    .match-versus {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 25px 20px;
      position: relative;
      background: radial-gradient(circle at center, rgba(200, 155, 60, 0.05) 0%, transparent 70%);
    }

    .player {
      flex: 1;
      text-align: center;
      font-family: 'Beaufort for LOL', serif;
      font-size: 22px;
      /* Bigger fonts */
      font-weight: 800;
      color: var(--text-main);
      padding: 15px 10px;
      transition: var(--transition);
      z-index: 2;
    }

    /* Winning Player Aesthetics */
    .player.winner-A {
      color: #E0FFFF;
      text-shadow: 0 0 15px var(--hex-cyan), 0 0 30px var(--hex-cyan);
      transform: scale(1.05);
    }

    .player.winner-B {
      color: #FFE0E0;
      text-shadow: 0 0 15px var(--hex-red), 0 0 30px var(--hex-red);
      transform: scale(1.05);
    }

    .player.loser {
      color: rgba(240, 230, 210, 0.3);
      text-shadow: none;
      filter: grayscale(100%);
    }

    .vs-badge {
      font-family: 'Beaufort for LOL', serif;
      color: var(--hex-gold-dark);
      font-size: 14px;
      padding: 0 15px;
      opacity: 0.6;
      font-style: italic;
      z-index: 1;
    }

    /* Betting Section */
    .bet-area {
      background: rgba(0, 0, 0, 0.6);
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      padding: 18px 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .bet-stats {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--text-muted);
      letter-spacing: 1px;
    }

    .bet-stats b {
      font-family: monospace;
      font-size: 14px;
    }

    /* Admin Action Section inside Match */
    .admin-actions {
      display: flex;
      justify-content: center;
      align-items: center;
      background: rgba(200, 155, 60, 0.05);
      padding: 12px 20px;
      border-top: 1px solid rgba(200, 155, 60, 0.1);
    }

    /* Premium Buttons */
    .btn {
      background: linear-gradient(180deg, #1E2328, #0A1428);
      border: 1px solid rgba(200, 155, 60, 0.4);
      color: var(--hex-gold-light);
      font-family: 'Beaufort for LOL', serif;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 4px;
      text-transform: uppercase;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 1.5px;
      transition: var(--transition);
      box-shadow: inset 0 0 0 1px transparent, 0 4px 10px rgba(0, 0, 0, 0.6);
      white-space: nowrap;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 50%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transform: skewX(-20deg);
      transition: 0.5s;
    }

    .btn:hover:not(:disabled) {
      background: linear-gradient(180deg, #2A333C, #121A2F);
      border-color: var(--hex-gold-light);
      text-shadow: 0 0 8px rgba(240, 230, 210, 0.6);
      box-shadow: inset 0 0 10px rgba(200, 155, 60, 0.2), 0 6px 15px rgba(0, 0, 0, 0.8);
    }

    .btn:hover:not(:disabled)::before {
      left: 150%;
    }

    .btn:active:not(:disabled) {
      transform: translateY(2px);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.8);
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      border-color: rgba(255, 255, 255, 0.1);
      color: #666;
    }

    .btn-action {
      background: linear-gradient(180deg, rgba(10, 200, 185, 0.15), rgba(10, 200, 185, 0.05));
      border-color: rgba(10, 200, 185, 0.5);
      color: var(--hex-cyan);
    }

    .btn-action:hover:not(:disabled) {
      background: linear-gradient(180deg, rgba(10, 200, 185, 0.25), rgba(10, 200, 185, 0.1));
      border-color: var(--hex-cyan);
      color: #E0FFFF;
      text-shadow: 0 0 10px var(--hex-cyan);
      box-shadow: inset 0 0 15px rgba(10, 200, 185, 0.2), 0 6px 15px rgba(0, 0, 0, 0.8);
    }

    .btn-danger {
      background: linear-gradient(180deg, rgba(232, 64, 87, 0.15), rgba(232, 64, 87, 0.05));
      border-color: rgba(232, 64, 87, 0.5);
      color: var(--hex-red);
    }

    .btn-danger:hover:not(:disabled) {
      border-color: var(--hex-red);
      color: #FFE0E0;
      text-shadow: 0 0 10px var(--hex-red);
      box-shadow: inset 0 0 15px rgba(232, 64, 87, 0.2), 0 6px 15px rgba(0, 0, 0, 0.8);
    }

    /* Premium Inputs */
    .input {
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text-main);
      padding: 10px 15px;
      border-radius: 4px;
      font-family: 'Spiegel', sans-serif;
      font-size: 14px;
      outline: none;
      width: 100%;
      transition: var(--transition);
      box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.5);
    }

    .input:focus {
      background: rgba(10, 20, 40, 0.6);
      border-color: var(--hex-cyan);
      box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.5), 0 0 8px rgba(10, 200, 185, 0.3);
    }

    .input:disabled {
      opacity: 0.5;
    }

    /* Chrome/Safari Hide Number Arrows for nicer UI */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input[type=number] {
      -moz-appearance: textfield;
      /* Firefox */
    }

    /* Custom Select */
    select.input {
      cursor: pointer;
      appearance: none;
      background-image: url('data:image/svg+xml;utf8,<svg fill="%23C89B3C" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 10px center;
      padding-right: 40px;
    }

    /* Login Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(1, 10, 19, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      transition: opacity 0.3s ease;
    }

    .modal-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .login-box {
      background: linear-gradient(180deg, rgba(16, 25, 45, 0.9), rgba(5, 10, 20, 1));
      border: 1px solid rgba(200, 155, 60, 0.3);
      padding: 40px;
      border-radius: 12px;
      width: 450px;
      max-width: 90%;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8), 0 0 30px rgba(200, 155, 60, 0.1);
      text-align: center;
      position: relative;
    }

    .login-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--hex-gold-light), transparent);
    }

    .login-box h2 {
      color: var(--hex-gold-light);
      margin-bottom: 30px;
      font-size: 32px;
      text-shadow: 0 0 15px rgba(200, 155, 60, 0.5);
    }

    /* Tables for Standings */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    th {
      text-align: left;
      color: var(--hex-gold-dark);
      font-family: 'Beaufort for LOL', serif;
      padding: 15px 15px;
      border-bottom: 1px solid rgba(200, 155, 60, 0.3);
      text-transform: uppercase;
      font-size: 13px;
      letter-spacing: 1px;
    }

    td {
      padding: 15px 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.03);
      color: var(--text-main);
      font-size: 15px;
      transition: background 0.2s ease;
    }

    tr:hover td {
      background: rgba(255, 255, 255, 0.03);
    }

    .rank-1 {
      color: #FFD700;
      font-weight: 800;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
      font-size: 18px;
    }

    .rank-2 {
      color: #E0E0E0;
      font-weight: 700;
      font-size: 16px;
    }

    .rank-3 {
      color: #CD7F32;
      font-weight: 700;
      font-size: 16px;
    }

    .text-green {
      color: var(--hex-green);
    }

    .text-red {
      color: var(--hex-red);
    }

    .text-cyan {
      color: var(--hex-cyan);
    }

    .text-gold {
      color: var(--hex-gold-light);
    }

    /* Utility */
    .flex-row {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .flex-col {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .mono {
      font-family: monospace;
      font-size: 1.15em;
      letter-spacing: 0.5px;
    }
  </style>
</head>

<body>

  <!-- Login Modal -->
  <div id="loginModal" class="modal-overlay">
    <div class="login-box">
      <h2>Connexion au Nexus</h2>
      <div class="flex-col">
        <select id="loginProfile" class="input"></select>
        <button id="btnLogin" class="btn btn-action" style="margin-top:10px; padding:12px;">Entrer dans la
          faille</button>
      </div>
      <p style="font-size:12px; color:var(--text-muted); margin-top:20px;">
        Les parieurs démarrent avec 100 crédits.<br>Mode Arbitre global activé pour cette session.
      </p>
    </div>
  </div>

  <!-- Navbar -->
  <nav class="navbar">
    <div class="brand">
      <h1>League Planner</h1>
    </div>
    <div class="nav-links">
      <button class="nav-btn active" data-target="dashboard">Accueil</button>
      <button class="nav-btn" data-target="matches">Matchs (BO1/BO3)</button>
      <button class="nav-btn" data-target="standings">Classements</button>
      <button class="nav-btn" data-target="admin">Système</button>
    </div>
    <div class="user-info">
      <span id="navUserName" style="color:var(--hex-gold-light); font-weight:bold;">-</span>
      <div class="credits-badge">
        <span id="navCredits" class="mono">0</span> ©
      </div>
      <button id="btnLogOut" class="btn" style="padding: 4px 8px; font-size:11px;">Se déconnecter</button>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container">

    <!-- DASHBOARD -->
    <div id="dashboard" class="section active">
      <div class="card">
        <div class="card-title">Aperçu du Tournoi (Round Robin 9 Joueurs)</div>
        <div style="display:flex; justify-content:space-between; color:var(--text-muted); margin-bottom: 20px;">
          <span>Progression : <b id="progCompleted" style="color:var(--hex-cyan);">0</b> / <span id="progTotal">0</span>
            matchs</span>
          <span>Gain minimum d'un pari réussi : <b style="color:var(--hex-green);">x2</b></span>
        </div>

        <h3 style="color:var(--hex-gold-dark); margin-bottom:15px; font-size:16px;">▶ Prochains Matchs à parier</h3>
        <div id="dashUpcoming" class="matches-grid"></div>

        <h3 style="color:var(--hex-gold-dark); margin:30px 0 15px; font-size:16px;">▶ Derniers Résultats</h3>
        <div id="dashRecent" class="matches-grid"></div>
      </div>
    </div>

    <!-- MATCHES -->
    <div id="matches" class="section">
      <div class="card">
        <div class="card-title">
          <span>Matchs et Paris</span>
          <input type="text" id="searchPlayer" class="input"
            style="width: 250px; font-size:14px; background:rgba(0,0,0,0.8);" placeholder="Chercher un joueur...">
        </div>
        <div id="matchesContainer" class="matches-grid"></div>
      </div>
    </div>

    <!-- STANDINGS -->
    <div id="standings" class="section">
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">

        <div class="card">
          <div class="card-title">Classement des Joueurs (Victoires)</div>
          <table>
            <thead>
              <tr>
                <th>Rank</th>
                <th>Joueur</th>
                <th>W</th>
                <th>L</th>
                <th>Pts</th>
              </tr>
            </thead>
            <tbody id="tableWins"></tbody>
          </table>
        </div>

        <div class="card">
          <div class="card-title">Classement des Parieurs (Crédits)</div>
          <table>
            <thead>
              <tr>
                <th>Rank</th>
                <th>Parieur</th>
                <th>Solde</th>
                <th>Win Rate</th>
              </tr>
            </thead>
            <tbody id="tableBets"></tbody>
          </table>
        </div>

      </div>
    </div>

    <!-- ADMIN -->
    <div id="admin" class="section">
      <div class="card">
        <div class="card-title">Administration Système</div>
        <p style="color:var(--text-muted); font-size:14px; margin-bottom:20px;">
          Le backend Firebase est connecté de manière permanente.
        </p>
        <div class="flex-row">
          <button id="btnAdminRecalc" class="btn">Recalculer les crédits</button>
          <button id="btnAdminUndo" class="btn">Annuler le dernier résultat</button>
          <button id="btnAdminReset" class="btn btn-danger">HARD RESET TOURNOI</button>
        </div>
      </div>
    </div>

  </div> <!-- End Container -->

  <script>
    /* =========================================================================
       FIREBASE CONFIGURATION (AUTO CONNECT)
       ========================================================================= */
    const firebaseConfig = {
      apiKey: "AIzaSyCacY7PWwxaEm-FrSC044BxAo0NPoSwpCI",
      authDomain: "league-2f027.firebaseapp.com",
      databaseURL: "https://league-2f027-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "league-2f027",
      storageBucket: "league-2f027.firebasestorage.app",
      messagingSenderId: "120664819458",
      appId: "1:120664819458:web:e84e697b8d615aa4e3641b",
      measurementId: "G-F5PZX2JEYM"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let fbPushSuppressed = false;

    /* =========================================================================
       TOURNAMENT DATA & STATE
       ========================================================================= */
    const RULES = {
      winPts: 3,
      losePts: 0,
      startCredits: 100
    };

    const PLAYERS = [
      { id: "p1", name: "Clément", pass: "CLEM1" },
      { id: "p2", name: "Quentin", pass: "QUEN1" },
      { id: "p3", name: "Mathieu", pass: "MATH1" },
      { id: "p4", name: "Benjamin", pass: "BENJ1" },
      { id: "p5", name: "Chris", pass: "CHRI1" },
      { id: "p6", name: "Heifara", pass: "HEIF1" },
      { id: "p7", name: "Goat", pass: "GOAT1" },
      { id: "p8", name: "Rémi", pass: "REMI1" },
      { id: "p9", name: "Thomas", pass: "THOM1" },
    ];
    const PUBLIC = { id: "pub", name: "Public", pass: "" };

    // Main App State
    let state = {
      version: 4, // LoL V3 simplified
      results: {}, // matchId -> { winner: "A"|"B", format: "BO1"|"BO3", score: "1-0"|"2-1"..., updatedAt: ... }
      bets: {},    // matchId -> { profileId -> { pick:"A"|"B", amount:X, settled:bool, payout:Y } }
      credits: {}, // profileId -> balance  (calculated on the fly mostly, but store allowed)
      undoStack: [] // {matchId, previousResultData}
    };

    // Local session (not synced to FB)
    let sessionId = localStorage.getItem("lol_planner_sess") || null;

    const ALL_PROFILES = [PUBLIC, ...PLAYERS];

    /* =========================================================================
       CORE LOGIC
       ========================================================================= */

    // 1. Generate Round Robin
    function generateRounds() {
      const ids = PLAYERS.map(p => p.id);
      if (ids.length % 2 === 1) ids.push("BYE");
      const rounds = [];
      const m = ids.length;
      let arr = [...ids];

      for (let r = 0; r < m - 1; r++) {
        const pairs = [];
        for (let i = 0; i < m / 2; i++) {
          const a = arr[i], b = arr[m - 1 - i];
          if (a !== "BYE" && b !== "BYE") {
            const sorted = [a, b].sort();
            pairs.push({ id: `m_${sorted[0]}_${sorted[1]}`, a, b, round: r + 1 });
          }
        }
        rounds.push({ round: r + 1, pairs });
        // Rotate
        const pivot = arr[0];
        const rest = arr.slice(1);
        rest.unshift(rest.pop());
        arr = [pivot, ...rest];
      }
      return rounds;
    }

    const TOURNAMENT_MATCHES = generateRounds().flatMap(r => r.pairs).sort((x, y) => x.round - y.round);
    const MATCH_MAP = new Map(TOURNAMENT_MATCHES.map(m => [m.id, m]));

    function getPlayerName(pid) { return PLAYERS.find(p => p.id === pid)?.name || pid; }
    function getProfileName(pid) { return ALL_PROFILES.find(p => p.id === pid)?.name || pid; }

    /* =========================================================================
       ECONOMY & BET SETTLEMENT (Preserving prior rules)
       ========================================================================= */

    // Initialize bases
    function getBaseEconomics() {
      const eco = { balances: {}, stats: {} };
      ALL_PROFILES.forEach(p => {
        eco.balances[p.id] = RULES.startCredits;
        eco.stats[p.id] = { bets: 0, wins: 0 };
      });
      return eco;
    }

    // Completely recalculate all credits based on bets and results.
    // This is robust against any state changes (undo, result edits).
    let ecoCache = getBaseEconomics();

    function rebuildEconomy() {
      ecoCache = getBaseEconomics();

      // 1. Deduct all placed bets (even unsettled ones)
      Object.keys(state.bets || {}).forEach(mid => {
        const book = state.bets[mid];
        Object.keys(book).forEach(pid => {
          const amt = Number(book[pid].amount) || 0;
          if (amt > 0) ecoCache.balances[pid] -= amt;
        });
      });

      // 2. Resolve settled matches
      TOURNAMENT_MATCHES.forEach(m => {
        const result = state.results[m.id];
        if (!result || !result.winner) return; // Not finished

        const book = state.bets[m.id] || {};
        const winId = result.winner; // "A" or "B"

        let poolWin = 0, poolLose = 0;

        // Calculate pools
        Object.values(book).forEach(b => {
          const amt = Number(b.amount) || 0;
          if (amt <= 0) return;
          if (b.pick === winId) poolWin += amt;
          else poolLose += amt;
        });

        if (poolWin > 0) {
          // Distribute
          Object.keys(book).forEach(pid => {
            const b = book[pid];
            const amt = Number(b.amount) || 0;
            if (amt > 0) {
              ecoCache.stats[pid].bets++;
              if (b.pick === winId) {
                // Winners get their stake back + equal piece of their stake from losing pool
                const sharePercent = amt / poolWin;
                const payout = (amt * 2) + (poolLose * sharePercent); // Guaranteed minimum x2
                ecoCache.balances[pid] += payout;
                ecoCache.stats[pid].wins++;
              }
            }
          });
        } else {
          // If no winners, house takes it (or rather, money is lost). Stats are updated.
          Object.keys(book).forEach(pid => {
            if (book[pid].amount > 0) ecoCache.stats[pid].bets++;
          });
        }
      });

      // Round to 2 decimals
      Object.keys(ecoCache.balances).forEach(pid => {
        ecoCache.balances[pid] = Math.round(ecoCache.balances[pid] * 100) / 100;
      });

      // Update Nav
      if (sessionId) {
        document.getElementById('navCredits').textContent = ecoCache.balances[sessionId];
      }
    }

    function getPotInfo(mid) {
      const book = state.bets[mid] || {};
      let total = 0, a = 0, b = 0;
      Object.values(book).forEach(bet => {
        const amt = Number(bet.amount) || 0;
        total += amt;
        if (bet.pick === "A") a += amt;
        if (bet.pick === "B") b += amt;
      });
      return { total, a, b };
    }

    /* =========================================================================
       ACTIONS
       ========================================================================= */

    function placeBet(mid, pick, amountStr) {
      if (!sessionId) return alert("Connectez-vous pour parier.");
      const m = MATCH_MAP.get(mid);
      if (state.results[mid]?.winner) return alert("Match terminé !");

      const amt = parseFloat(amountStr);
      if (isNaN(amt) || amt <= 0) return alert("Mise invalide");

      // To replace a bet, we must calculate theoretical balance WITHOUT current bet for this match
      const currentBetAmt = state.bets[mid]?.[sessionId]?.amount || 0;
      const theoreticalBal = ecoCache.balances[sessionId] + currentBetAmt;

      if (theoreticalBal < amt) return alert("Crédits insuffisants");

      if (!state.bets[mid]) state.bets[mid] = {};
      state.bets[mid][sessionId] = { pick, amount: amt };
      syncState();
    }

    function cancelBet(mid) {
      if (!sessionId) return;
      if (state.results[mid]?.winner) return alert("Match terminé !");
      if (state.bets[mid] && state.bets[mid][sessionId]) {
        delete state.bets[mid][sessionId];
        syncState();
      }
    }

    function resolveMatch(mid, scoreA, scoreB) {
      if (!sessionId) return alert("Connectez-vous.");

      const sA = parseInt(scoreA, 10);
      const sB = parseInt(scoreB, 10);
      if (isNaN(sA) || isNaN(sB) || sA === sB) return alert("Score invalide ou match nul non supporté.");

      const winnerPick = sA > sB ? "A" : "B";

      // Save for Undo
      const oldRes = state.results[mid] ? JSON.parse(JSON.stringify(state.results[mid])) : null;
      state.undoStack.push({ matchId: mid, prev: oldRes });
      if (state.undoStack.length > 50) state.undoStack.shift();

      state.results[mid] = {
        winner: winnerPick,
        scoreA: sA,
        scoreB: sB,
        score: `${sA}-${sB}`,
        updatedAt: new Date().toISOString()
      };
      syncState();
    }

    function undoLast() {
      if (state.undoStack.length === 0) return alert("Rien à annuler.");
      const action = state.undoStack.pop();
      if (action.prev === null) {
        delete state.results[action.matchId];
      } else {
        state.results[action.matchId] = action.prev;
      }
      syncState();
    }

    /* =========================================================================
       Firebase Syncing
       ========================================================================= */
    const fbRef = db.ref('v4State');

    function syncState() {
      fbPushSuppressed = true;
      fbRef.set(state).then(() => {
        setTimeout(() => fbPushSuppressed = false, 500);
      });
      // Local optimstic update
      rebuildEconomy();
      renderApp();
    }

    fbRef.on('value', snap => {
      const data = snap.val();
      if (data && !fbPushSuppressed) {
        // Ensure structure mapping
        state.results = data.results || {};
        state.bets = data.bets || {};
        state.undoStack = data.undoStack || [];
        rebuildEconomy();
        renderApp();
      }
    });

    /* =========================================================================
       UI RENDERERS
       ========================================================================= */
    const $ = id => document.getElementById(id);

    function renderMatchCard(m, context) {
      const res = state.results[m.id];
      const isFinished = !!res;
      const pot = getPotInfo(m.id);

      const myBet = state.bets[m.id]?.[sessionId];
      const hasBet = !!myBet;

      // Header
      let statusHTML = isFinished
        ? `<span class="text-${res.winner === 'A' ? 'cyan' : 'red'}">TERMINÉ • ${res.score}</span>`
        : `<span style="color:var(--text-muted)">EN ATTENTE</span>`;

      // Players
      let winClassA = isFinished ? (res.winner === "A" ? "winner-A" : "loser") : "";
      let winClassB = isFinished ? (res.winner === "B" ? "winner-B" : "loser") : "";

      let cardWinnerClass = isFinished ? `finished-${res.winner}` : "";

      // Betting UI
      let betHTML = "";
      if (isFinished) {
        if (hasBet) {
          const won = myBet.pick === res.winner;
          betHTML = `<div class="bet-area">
              <div style="text-align:center; font-size:14px; font-weight:bold; letter-spacing:1px;" class="${won ? 'text-green' : 'text-red'}">
                ${won ? '✓ VICTOIRE DU PARI' : '✗ PARI PERDU'} (${myBet.amount}© sur ${myBet.pick === "A" ? getPlayerName(m.a) : getPlayerName(m.b)})
              </div>
            </div>`;
        } else {
          betHTML = `<div class="bet-area" style="text-align:center; color:var(--text-muted); font-size: 13px;">Match terminé • Cagnotte finale : <b class="text-gold mono">${pot.total}©</b></div>`;
        }
      } else {
        // Open for bets
        let inputs = `
            <div class="flex-row">
              <select id="pick_${m.id}" class="input" style="flex:1;">
                <option value="A" ${myBet?.pick === 'A' ? 'selected' : ''}>${getPlayerName(m.a)}</option>
                <option value="B" ${myBet?.pick === 'B' ? 'selected' : ''}>${getPlayerName(m.b)}</option>
              </select>
              <input type="number" id="amt_${m.id}" class="input mono" placeholder="Mise" value="${myBet?.amount || ''}" style="width:110px;">
              <button class="btn btn-action" onclick="placeBet('${m.id}', $('pick_${m.id}').value, $('amt_${m.id}').value)">${hasBet ? 'Modifier' : 'Miser'}</button>
              ${hasBet ? `<button class="btn" style="background:transparent;border:none;padding:5px 10px;box-shadow:none;min-width:auto;" onclick="cancelBet('${m.id}')" title="Annuler le pari">✕</button>` : ''}
            </div>
         `;
        if (!sessionId) inputs = `<div class="text-red" style="font-size:13px; text-align:center;">Connectez-vous pour parier sur ce match.</div>`;

        betHTML = `
           <div class="bet-area">
              <div class="bet-stats">
                <span>Cagnotte Globale : <b class="text-gold mono">${pot.total}©</b></span>
                <span>(A: <b class="mono">${pot.a}</b> | B: <b class="mono">${pot.b}</b>)</span>
              </div>
              ${inputs}
           </div>
         `;
      }

      // Admin Controls (Visible if logged in, acting as global arbitrary ref)
      let adminHTML = "";
      if (sessionId && !isFinished) {
        adminHTML = `
           <div class="admin-actions" style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center;">
             <div style="display:flex; align-items:center; background: rgba(0,0,0,0.5); padding: 4px 10px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05);">
                 <button class="btn" style="padding:2px 8px; font-size:14px; min-width:30px;" onclick="$('sa_${m.id}').stepDown()">-</button>
                 <input type="number" id="sa_${m.id}" class="input mono" value="0" min="0" max="3" style="width:35px; padding:0; text-align:center; font-size:16px; background: transparent; border: none; box-shadow: none;">
                 <button class="btn" style="padding:2px 8px; font-size:14px; min-width:30px;" onclick="$('sa_${m.id}').stepUp()">+</button>
                 
                 <span style="font-weight:bold; margin:0 5px; color:var(--hex-gold-dark);">VS</span>
                 
                 <button class="btn" style="padding:2px 8px; font-size:14px; min-width:30px;" onclick="$('sb_${m.id}').stepDown()">-</button>
                 <input type="number" id="sb_${m.id}" class="input mono" value="0" min="0" max="3" style="width:35px; padding:0; text-align:center; font-size:16px; background: transparent; border: none; box-shadow: none;">
                 <button class="btn" style="padding:2px 8px; font-size:14px; min-width:30px;" onclick="$('sb_${m.id}').stepUp()">+</button>
             </div>
             <button class="btn btn-action" style="padding:6px 15px; font-size:12px;" onclick="resolveMatch('${m.id}', $('sa_${m.id}').value, $('sb_${m.id}').value)">Valider</button>
           </div>
         `;
      }

      return `
        <div class="match-card ${isFinished ? 'finished' : ''}">
          <div class="match-header">
            <span>Round ${m.round}</span>
            ${statusHTML}
          </div>
          
          <div class="match-versus">
            <div class="player ${winClassA}">${getPlayerName(m.a)}</div>
            <div class="vs-badge">VS</div>
            <div class="player ${winClassB}">${getPlayerName(m.b)}</div>
          </div>
          
          ${betHTML}
          ${adminHTML}
        </div>
      `;
    }

    function renderDashboard() {
      let fin = [], up = [];
      TOURNAMENT_MATCHES.forEach(m => {
        if (state.results[m.id]) fin.push(m);
        else up.push(m);
      });

      $('progCompleted').textContent = fin.length;
      $('progTotal').textContent = TOURNAMENT_MATCHES.length;

      // Next 6 matches
      $('dashUpcoming').innerHTML = up.slice(0, 6).map(m => renderMatchCard(m, 'dash')).join('') || "<p style='color:var(--text-muted)'>Aucun match programmé.</p>";

      // Last 3 finished
      let recent = fin.sort((a, b) => {
        const tA = new Date(state.results[a.id].updatedAt).getTime();
        const tB = new Date(state.results[b.id].updatedAt).getTime();
        return tB - tA;
      }).slice(0, 3);
      $('dashRecent').innerHTML = recent.map(m => renderMatchCard(m, 'dash')).join('') || "<p style='color:var(--text-muted)'>Aucun match terminé.</p>";
    }

    function renderMatchesTab() {
      const query = $('searchPlayer') ? $('searchPlayer').value.toLowerCase().trim() : "";
      let html = "";
      TOURNAMENT_MATCHES.forEach(m => {
        const pA = getPlayerName(m.a).toLowerCase();
        const pB = getPlayerName(m.b).toLowerCase();
        if (!query || pA.includes(query) || pB.includes(query)) {
          html += renderMatchCard(m, 'list');
        }
      });
      $('matchesContainer').innerHTML = html;
    }

    function renderStandings() {
      // 1. Players Standings (Wins)
      let pts = {}; PLAYERS.forEach(p => pts[p.id] = { id: p.id, name: p.name, w: 0, l: 0, pts: 0 });

      TOURNAMENT_MATCHES.forEach(m => {
        const res = state.results[m.id];
        if (!res) return;

        // Dynamically calculate points: 2-1 gives less points than 2-0.
        // Assuming base win gives 3 points (RULES.winPts). A close 2-1 gives 2 points.
        let matchWinPts = RULES.winPts;
        if (res.scoreA !== undefined && res.scoreB !== undefined) {
          if ((res.scoreA === 2 && res.scoreB === 1) || (res.scoreA === 1 && res.scoreB === 2)) {
            matchWinPts = 2;
          }
        } else if (res.score) {
          // Fallback for matches manually entered as "2-1" or "1-2" in older versions
          if (res.score === "2-1" || res.score === "1-2") matchWinPts = 2;
        }

        if (res.winner === "A") { pts[m.a].w++; pts[m.b].l++; pts[m.a].pts += matchWinPts; }
        if (res.winner === "B") { pts[m.b].w++; pts[m.a].l++; pts[m.b].pts += matchWinPts; }
      });

      let ranking = Object.values(pts).sort((a, b) => b.pts - a.pts || a.name.localeCompare(b.name));
      $('tableWins').innerHTML = ranking.map((p, i) => `
        <tr>
          <td class="rank-${i + 1}">${i + 1}</td>
          <td style="font-family:'Beaufort for LOL', serif;">${p.name}</td>
          <td>${p.w}</td>
          <td>${p.l}</td>
          <td class="text-green" style="font-weight:bold;">${p.pts}</td>
        </tr>
      `).join('');

      // 2. Bettors Standings
      let betsRanking = ALL_PROFILES.map(p => {
        const bal = ecoCache.balances[p.id] || 0;
        const stats = ecoCache.stats[p.id] || { bets: 0, wins: 0 };
        const wr = stats.bets > 0 ? Math.round((stats.wins / stats.bets) * 100) : 0;
        return { name: p.name, bal, wr };
      }).sort((a, b) => b.bal - a.bal || b.wr - a.wr);

      $('tableBets').innerHTML = betsRanking.map((p, i) => `
        <tr>
          <td class="rank-${i + 1}">${i + 1}</td>
          <td>${p.name}</td>
          <td style="color:var(--hex-gold-light); font-weight:bold;" class="mono">${p.bal} ©</td>
          <td>${p.wr}%</td>
        </tr>
      `).join('');
    }

    function renderApp() {
      if (!state.results) state.results = {}; // safe wrapper
      if (!ecoCache) rebuildEconomy();

      renderDashboard();
      renderMatchesTab();
      renderStandings();
    }

    /* =========================================================================
       NAVIGATION & INIT
       ========================================================================= */

    // Auth logic
    function setSession(id) {
      sessionId = id;
      if (id) localStorage.setItem("lol_planner_sess", id);
      else localStorage.removeItem("lol_planner_sess");

      if (id) {
        $('loginModal').classList.add('hidden');
        $('navUserName').textContent = getProfileName(id);
      } else {
        $('loginModal').classList.remove('hidden');
        $('navUserName').textContent = "-";
        $('navCredits').textContent = "0";
      }
      renderApp();
    }

    $('btnLogin').addEventListener('click', () => {
      const p = $('loginProfile').value;
      setSession(p);
    });

    $('btnLogOut').addEventListener('click', () => setSession(null));

    // Nav Logic
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        e.target.classList.add('active');
        $(e.target.dataset.target).classList.add('active');
        renderApp(); // re-render view
      });
    });

    $('searchPlayer').addEventListener('input', renderMatchesTab);

    // Admin Tools
    $('btnAdminUndo').addEventListener('click', undoLast);
    $('btnAdminRecalc').addEventListener('click', () => { rebuildEconomy(); renderApp(); alert("Economie recalculée."); });
    $('btnAdminReset').addEventListener('click', () => {
      if (!confirm("DANGER : Supprimer tous les matchs, paris et resets l'argent à 100 ?")) return;
      state.results = {};
      state.bets = {};
      state.undoStack = [];
      syncState();
    });

    // Boot
    window.onload = () => {
      // Build selects
      $('loginProfile').innerHTML = ALL_PROFILES.map(p => `<option value="${p.id}">${p.name}</option>`).join('');



      // Auto login check
      setSession(sessionId);
    };

  </script>
</body>

</html>