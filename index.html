<!doctype html>
<html lang="fr">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>League Planner V3 - Nexus</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-analytics-compat.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Beaufort+for+LOL:wght@400;700&family=Spiegel:wght@400;600&display=swap');

    :root {
      /* LoL Hextech Theme Colors */
      --hex-blue-dark: #0A1428;
      --hex-blue-light: #091428;
      --hex-gold-dark: #C89B3C;
      --hex-gold-light: #F0E6D2;
      --hex-cyan: #0AC8B9;
      --hex-red: #E84057;
      --hex-green: #00FF99;
      --hex-bg: #010A13;
      --hex-panel: rgba(10, 20, 40, 0.85);
      --hex-border: #785A28;
      --text-main: #F0E6D2;
      --text-muted: #A09B8C;

      --shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
      --r: 8px;
      /* Sharper corners for a gaming feel */
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      font-family: 'Spiegel', sans-serif;
      color: var(--text-main);
      background-color: var(--hex-bg);
      background-image:
        radial-gradient(circle at 50% 0%, rgba(10, 200, 185, 0.1), transparent 40%),
        radial-gradient(circle at 100% 100%, rgba(200, 155, 60, 0.05), transparent 50%),
        url('data:image/svg+xml;utf8,<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M0 0 L100 100 M100 0 L0 100" stroke="rgba(200,155,60,0.02)" stroke-width="1"/></svg>');
      background-size: cover, cover, 100px 100px;
      background-attachment: fixed;
      overflow-x: hidden;
    }

    h1,
    h2,
    h3,
    h4 {
      font-family: 'Beaufort for LOL', serif;
      font-weight: 700;
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Top Navigation bar */
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 30px;
      background: linear-gradient(to bottom, #010A13, rgba(1, 10, 19, 0.8));
      border-bottom: 2px solid var(--hex-border);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .brand h1 {
      color: var(--hex-gold-dark);
      font-size: 24px;
      text-shadow: 0 0 10px rgba(200, 155, 60, 0.5);
    }

    .nav-links {
      display: flex;
      gap: 20px;
    }

    .nav-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      font-family: 'Beaufort for LOL', serif;
      font-size: 16px;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 1px;
      padding: 8px 12px;
      transition: all 0.3s ease;
      position: relative;
    }

    .nav-btn::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 2px;
      background-color: var(--hex-gold-dark);
      transition: width 0.3s ease;
    }

    .nav-btn:hover {
      color: var(--hex-gold-light);
    }

    .nav-btn:hover::after,
    .nav-btn.active::after {
      width: 100%;
    }

    .nav-btn.active {
      color: var(--hex-gold-light);
      text-shadow: 0 0 8px rgba(200, 155, 60, 0.6);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
      font-size: 14px;
    }

    .credits-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(10, 200, 185, 0.1);
      border: 1px solid var(--hex-cyan);
      padding: 5px 12px;
      border-radius: 4px;
      color: var(--hex-cyan);
      font-weight: bold;
      box-shadow: 0 0 10px rgba(10, 200, 185, 0.2);
    }

    /* Main Container */
    .container {
      max-width: 1200px;
      margin: 30px auto;
      padding: 0 20px;
    }

    .section {
      display: none;
      animation: fadeIn 0.4s ease;
    }

    .section.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Cards */
    .card {
      background: var(--hex-panel);
      border: 1px solid var(--hex-border);
      border-radius: var(--r);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--hex-gold-dark), transparent);
    }

    .card-title {
      color: var(--hex-gold-dark);
      font-size: 18px;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(120, 90, 40, 0.3);
      padding-bottom: 10px;
    }

    /* Matches Grid */
    .matches-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
    }

    /* Reimagined Match Card */
    .match-card {
      background: linear-gradient(135deg, rgba(10, 20, 40, 0.9), rgba(5, 10, 20, 0.95));
      border: 1px solid rgba(120, 90, 40, 0.4);
      border-radius: 6px;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      position: relative;
    }

    .match-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.8), 0 0 10px rgba(200, 155, 60, 0.2);
      border-color: var(--hex-gold-dark);
    }

    .match-card.finished {
      border-color: rgba(10, 200, 185, 0.4);
    }

    .match-card.finished:hover {
      border-color: var(--hex-cyan);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.8), 0 0 10px rgba(10, 200, 185, 0.2);
    }

    .match-header {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .match-versus {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 10px 0;
    }

    .player {
      flex: 1;
      text-align: center;
      font-family: 'Beaufort for LOL', serif;
      font-size: 18px;
      color: var(--text-main);
      padding: 10px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 4px;
      border: 1px solid transparent;
    }

    .player.winner {
      color: var(--hex-gold-light);
      background: rgba(200, 155, 60, 0.15);
      border-color: var(--hex-gold-dark);
      text-shadow: 0 0 8px rgba(200, 155, 60, 0.5);
    }

    .vs-badge {
      font-family: 'Beaufort for LOL', serif;
      color: var(--hex-gold-dark);
      font-size: 14px;
      padding: 0 15px;
    }

    /* Betting Section */
    .bet-area {
      background: rgba(0, 0, 0, 0.4);
      border-top: 1px solid rgba(120, 90, 40, 0.2);
      padding: 12px;
      border-radius: 0 0 6px 6px;
      margin: -15px;
      /* Pull to edges */
      margin-top: 5px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .bet-stats {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--text-muted);
    }

    .bet-controls {
      display: flex;
      gap: 10px;
    }

    /* Admin Action Section inside Match */
    .admin-actions {
      display: flex;
      gap: 10px;
      border-top: 1px dashed rgba(200, 155, 60, 0.3);
      padding-top: 10px;
      margin-top: 5px;
    }

    /* Buttons */
    .btn {
      background: linear-gradient(180deg, #1E2328, #0A1428);
      border: 1px solid var(--hex-border);
      color: var(--hex-gold-light);
      font-family: 'Beaufort for LOL', serif;
      padding: 8px 16px;
      cursor: pointer;
      border-radius: 4px;
      text-transform: uppercase;
      font-size: 13px;
      letter-spacing: 1px;
      transition: all 0.2s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
      white-space: nowrap;
    }

    .btn:hover:not(:disabled) {
      background: linear-gradient(180deg, #2A333C, #1E2328);
      border-color: var(--hex-gold-light);
      text-shadow: 0 0 5px rgba(240, 230, 210, 0.5);
    }

    .btn:active:not(:disabled) {
      transform: translateY(1px);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      border-color: #333;
      color: #777;
    }

    .btn-action {
      background: linear-gradient(180deg, rgba(10, 200, 185, 0.2), rgba(10, 200, 185, 0.05));
      border-color: var(--hex-cyan);
      color: #E0FFFF;
    }

    .btn-action:hover:not(:disabled) {
      background: linear-gradient(180deg, rgba(10, 200, 185, 0.3), rgba(10, 200, 185, 0.1));
      border-color: #E0FFFF;
    }

    .btn-danger {
      background: linear-gradient(180deg, rgba(232, 64, 87, 0.2), rgba(232, 64, 87, 0.05));
      border-color: var(--hex-red);
      color: #FFE0E0;
    }

    /* Inputs */
    .input {
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(120, 90, 40, 0.4);
      color: var(--text-main);
      padding: 8px 12px;
      border-radius: 4px;
      font-family: 'Spiegel', sans-serif;
      outline: none;
      width: 100%;
      transition: border-color 0.2s ease;
    }

    .input:focus {
      border-color: var(--hex-cyan);
    }

    .input:disabled {
      opacity: 0.6;
    }

    /* Login Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(1, 10, 19, 0.9);
      backdrop-filter: blur(8px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-overlay.hidden {
      display: none;
    }

    .login-box {
      background: #0A1428;
      border: 2px solid var(--hex-border);
      padding: 30px;
      border-radius: 8px;
      width: 400px;
      max-width: 90%;
      box-shadow: 0 0 50px rgba(200, 155, 60, 0.15);
      text-align: center;
    }

    .login-box h2 {
      color: var(--hex-gold-dark);
      margin-bottom: 20px;
      font-size: 28px;
    }

    /* Tables for Standings */
    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      text-align: left;
      color: var(--hex-gold-dark);
      font-family: 'Beaufort for LOL', serif;
      padding: 10px;
      border-bottom: 2px solid rgba(120, 90, 40, 0.4);
      text-transform: uppercase;
      font-size: 14px;
    }

    td {
      padding: 12px 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      color: var(--text-main);
    }

    tr:hover td {
      background: rgba(255, 255, 255, 0.03);
    }

    .rank-1 {
      color: #FFD700;
      font-weight: bold;
      text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
    }

    .rank-2 {
      color: #C0C0C0;
    }

    .rank-3 {
      color: #CD7F32;
    }

    .text-green {
      color: var(--hex-green);
    }

    .text-red {
      color: var(--hex-red);
    }

    /* Utility */
    .flex-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .flex-col {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .mt-20 {
      margin-top: 20px;
    }

    .mb-10 {
      margin-bottom: 10px;
    }

    .mono {
      font-family: monospace;
      font-size: 1.1em;
    }

    /* Custom Select */
    select {
      appearance: none;
      background-image: url('data:image/svg+xml;utf8,<svg fill="%23C89B3C" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
      background-repeat: no-repeat;
      background-position-x: 95%;
      background-position-y: 50%;
    }
  </style>
</head>

<body>

  <!-- Login Modal -->
  <div id="loginModal" class="modal-overlay">
    <div class="login-box">
      <h2>Connexion au Nexus</h2>
      <div class="flex-col">
        <select id="loginProfile" class="input"></select>
        <button id="btnLogin" class="btn btn-action" style="margin-top:10px; padding:12px;">Entrer dans la
          faille</button>
      </div>
      <p style="font-size:12px; color:var(--text-muted); margin-top:20px;">
        Les parieurs démarrent avec 100 crédits.<br>Mode Arbitre global activé pour cette session.
      </p>
    </div>
  </div>

  <!-- Navbar -->
  <nav class="navbar">
    <div class="brand">
      <h1>League Planner</h1>
    </div>
    <div class="nav-links">
      <button class="nav-btn active" data-target="dashboard">Accueil</button>
      <button class="nav-btn" data-target="matches">Matchs (BO1/BO3)</button>
      <button class="nav-btn" data-target="standings">Classements</button>
      <button class="nav-btn" data-target="admin">Système</button>
    </div>
    <div class="user-info">
      <span id="navUserName" style="color:var(--hex-gold-light); font-weight:bold;">-</span>
      <div class="credits-badge">
        <span id="navCredits" class="mono">0</span> ©
      </div>
      <button id="btnLogOut" class="btn" style="padding: 4px 8px; font-size:11px;">Se déconnecter</button>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container">

    <!-- DASHBOARD -->
    <div id="dashboard" class="section active">
      <div class="card">
        <div class="card-title">Aperçu du Tournoi (Round Robin 9 Joueurs)</div>
        <div style="display:flex; justify-content:space-between; color:var(--text-muted); margin-bottom: 20px;">
          <span>Progression : <b id="progCompleted" style="color:var(--hex-cyan);">0</b> / <span id="progTotal">0</span>
            matchs</span>
          <span>Gain minimum d'un pari réussi : <b style="color:var(--hex-green);">x2</b></span>
        </div>

        <h3 style="color:var(--hex-gold-dark); margin-bottom:15px; font-size:16px;">▶ Prochains Matchs à parier</h3>
        <div id="dashUpcoming" class="matches-grid"></div>

        <h3 style="color:var(--hex-gold-dark); margin:30px 0 15px; font-size:16px;">▶ Derniers Résultats</h3>
        <div id="dashRecent" class="matches-grid"></div>
      </div>
    </div>

    <!-- MATCHES -->
    <div id="matches" class="section">
      <div class="card">
        <div class="card-title">
          <span>Matchs et Paris</span>
          <select id="filterRound" class="input" style="width: 200px; font-size:14px; background:rgba(0,0,0,0.8);">
            <option value="all">Tous les rounds</option>
          </select>
        </div>
        <div id="matchesContainer" class="matches-grid"></div>
      </div>
    </div>

    <!-- STANDINGS -->
    <div id="standings" class="section">
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">

        <div class="card">
          <div class="card-title">Classement des Joueurs (Victoires)</div>
          <table>
            <thead>
              <tr>
                <th>Rank</th>
                <th>Joueur</th>
                <th>W</th>
                <th>L</th>
                <th>Pts</th>
              </tr>
            </thead>
            <tbody id="tableWins"></tbody>
          </table>
        </div>

        <div class="card">
          <div class="card-title">Classement des Parieurs (Crédits)</div>
          <table>
            <thead>
              <tr>
                <th>Rank</th>
                <th>Parieur</th>
                <th>Solde</th>
                <th>Win Rate</th>
              </tr>
            </thead>
            <tbody id="tableBets"></tbody>
          </table>
        </div>

      </div>
    </div>

    <!-- ADMIN -->
    <div id="admin" class="section">
      <div class="card">
        <div class="card-title">Administration Système</div>
        <p style="color:var(--text-muted); font-size:14px; margin-bottom:20px;">
          Le backend Firebase est connecté de manière permanente.
        </p>
        <div class="flex-row">
          <button id="btnAdminRecalc" class="btn">Recalculer les crédits</button>
          <button id="btnAdminUndo" class="btn">Annuler le dernier résultat</button>
          <button id="btnAdminReset" class="btn btn-danger">HARD RESET TOURNOI</button>
        </div>
      </div>
    </div>

  </div> <!-- End Container -->

  <script>
    /* =========================================================================
       FIREBASE CONFIGURATION (AUTO CONNECT)
       ========================================================================= */
    const firebaseConfig = {
      apiKey: "AIzaSyCacY7PWwxaEm-FrSC044BxAo0NPoSwpCI",
      authDomain: "league-2f027.firebaseapp.com",
      databaseURL: "https://league-2f027-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "league-2f027",
      storageBucket: "league-2f027.firebasestorage.app",
      messagingSenderId: "120664819458",
      appId: "1:120664819458:web:e84e697b8d615aa4e3641b",
      measurementId: "G-F5PZX2JEYM"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let fbPushSuppressed = false;

    /* =========================================================================
       TOURNAMENT DATA & STATE
       ========================================================================= */
    const RULES = {
      winPts: 3,
      losePts: 0,
      startCredits: 100
    };

    const PLAYERS = [
      { id: "p1", name: "Clément", pass: "CLEM1" },
      { id: "p2", name: "Quentin", pass: "QUEN1" },
      { id: "p3", name: "Mathieu", pass: "MATH1" },
      { id: "p4", name: "Benjamin", pass: "BENJ1" },
      { id: "p5", name: "Chris", pass: "CHRI1" },
      { id: "p6", name: "Heifara", pass: "HEIF1" },
      { id: "p7", name: "Goat", pass: "GOAT1" },
      { id: "p8", name: "Rémi", pass: "REMI1" },
      { id: "p9", name: "Thomas", pass: "THOM1" },
    ];
    const PUBLIC = { id: "pub", name: "Public", pass: "" };

    // Main App State
    let state = {
      version: 4, // LoL V3 simplified
      results: {}, // matchId -> { winner: "A"|"B", format: "BO1"|"BO3", score: "1-0"|"2-1"..., updatedAt: ... }
      bets: {},    // matchId -> { profileId -> { pick:"A"|"B", amount:X, settled:bool, payout:Y } }
      credits: {}, // profileId -> balance  (calculated on the fly mostly, but store allowed)
      undoStack: [] // {matchId, previousResultData}
    };

    // Local session (not synced to FB)
    let sessionId = localStorage.getItem("lol_planner_sess") || null;

    const ALL_PROFILES = [PUBLIC, ...PLAYERS];

    /* =========================================================================
       CORE LOGIC
       ========================================================================= */

    // 1. Generate Round Robin
    function generateRounds() {
      const ids = PLAYERS.map(p => p.id);
      if (ids.length % 2 === 1) ids.push("BYE");
      const rounds = [];
      const m = ids.length;
      let arr = [...ids];

      for (let r = 0; r < m - 1; r++) {
        const pairs = [];
        for (let i = 0; i < m / 2; i++) {
          const a = arr[i], b = arr[m - 1 - i];
          if (a !== "BYE" && b !== "BYE") {
            const sorted = [a, b].sort();
            pairs.push({ id: `m_${sorted[0]}_${sorted[1]}`, a, b, round: r + 1 });
          }
        }
        rounds.push({ round: r + 1, pairs });
        // Rotate
        const pivot = arr[0];
        const rest = arr.slice(1);
        rest.unshift(rest.pop());
        arr = [pivot, ...rest];
      }
      return rounds;
    }

    const TOURNAMENT_MATCHES = generateRounds().flatMap(r => r.pairs).sort((x, y) => x.round - y.round);
    const MATCH_MAP = new Map(TOURNAMENT_MATCHES.map(m => [m.id, m]));

    function getPlayerName(pid) { return PLAYERS.find(p => p.id === pid)?.name || pid; }
    function getProfileName(pid) { return ALL_PROFILES.find(p => p.id === pid)?.name || pid; }

    /* =========================================================================
       ECONOMY & BET SETTLEMENT (Preserving prior rules)
       ========================================================================= */

    // Initialize bases
    function getBaseEconomics() {
      const eco = { balances: {}, stats: {} };
      ALL_PROFILES.forEach(p => {
        eco.balances[p.id] = RULES.startCredits;
        eco.stats[p.id] = { bets: 0, wins: 0 };
      });
      return eco;
    }

    // Completely recalculate all credits based on bets and results.
    // This is robust against any state changes (undo, result edits).
    let ecoCache = getBaseEconomics();

    function rebuildEconomy() {
      ecoCache = getBaseEconomics();

      // 1. Deduct all placed bets (even unsettled ones)
      Object.keys(state.bets || {}).forEach(mid => {
        const book = state.bets[mid];
        Object.keys(book).forEach(pid => {
          const amt = Number(book[pid].amount) || 0;
          if (amt > 0) ecoCache.balances[pid] -= amt;
        });
      });

      // 2. Resolve settled matches
      TOURNAMENT_MATCHES.forEach(m => {
        const result = state.results[m.id];
        if (!result || !result.winner) return; // Not finished

        const book = state.bets[m.id] || {};
        const winId = result.winner; // "A" or "B"

        let poolWin = 0, poolLose = 0;

        // Calculate pools
        Object.values(book).forEach(b => {
          const amt = Number(b.amount) || 0;
          if (amt <= 0) return;
          if (b.pick === winId) poolWin += amt;
          else poolLose += amt;
        });

        if (poolWin > 0) {
          // Distribute
          Object.keys(book).forEach(pid => {
            const b = book[pid];
            const amt = Number(b.amount) || 0;
            if (amt > 0) {
              ecoCache.stats[pid].bets++;
              if (b.pick === winId) {
                // Winners get their stake back + equal piece of their stake from losing pool
                const sharePercent = amt / poolWin;
                const payout = (amt * 2) + (poolLose * sharePercent); // Guaranteed minimum x2
                ecoCache.balances[pid] += payout;
                ecoCache.stats[pid].wins++;
              }
            }
          });
        } else {
          // If no winners, house takes it (or rather, money is lost). Stats are updated.
          Object.keys(book).forEach(pid => {
            if (book[pid].amount > 0) ecoCache.stats[pid].bets++;
          });
        }
      });

      // Round to 2 decimals
      Object.keys(ecoCache.balances).forEach(pid => {
        ecoCache.balances[pid] = Math.round(ecoCache.balances[pid] * 100) / 100;
      });

      // Update Nav
      if (sessionId) {
        document.getElementById('navCredits').textContent = ecoCache.balances[sessionId];
      }
    }

    function getPotInfo(mid) {
      const book = state.bets[mid] || {};
      let total = 0, a = 0, b = 0;
      Object.values(book).forEach(bet => {
        const amt = Number(bet.amount) || 0;
        total += amt;
        if (bet.pick === "A") a += amt;
        if (bet.pick === "B") b += amt;
      });
      return { total, a, b };
    }

    /* =========================================================================
       ACTIONS
       ========================================================================= */

    function placeBet(mid, pick, amountStr) {
      if (!sessionId) return alert("Connectez-vous pour parier.");
      const m = MATCH_MAP.get(mid);
      if (state.results[mid]?.winner) return alert("Match terminé !");

      const amt = parseFloat(amountStr);
      if (isNaN(amt) || amt <= 0) return alert("Mise invalide");

      // To replace a bet, we must calculate theoretical balance WITHOUT current bet for this match
      const currentBetAmt = state.bets[mid]?.[sessionId]?.amount || 0;
      const theoreticalBal = ecoCache.balances[sessionId] + currentBetAmt;

      if (theoreticalBal < amt) return alert("Crédits insuffisants");

      if (!state.bets[mid]) state.bets[mid] = {};
      state.bets[mid][sessionId] = { pick, amount: amt };
      syncState();
    }

    function cancelBet(mid) {
      if (!sessionId) return;
      if (state.results[mid]?.winner) return alert("Match terminé !");
      if (state.bets[mid] && state.bets[mid][sessionId]) {
        delete state.bets[mid][sessionId];
        syncState();
      }
    }

    function resolveMatch(mid, scoreA, scoreB) {
      if (!sessionId) return alert("Connectez-vous.");

      const sA = parseInt(scoreA, 10);
      const sB = parseInt(scoreB, 10);
      if (isNaN(sA) || isNaN(sB) || sA === sB) return alert("Score invalide ou match nul non supporté.");

      const winnerPick = sA > sB ? "A" : "B";

      // Save for Undo
      const oldRes = state.results[mid] ? JSON.parse(JSON.stringify(state.results[mid])) : null;
      state.undoStack.push({ matchId: mid, prev: oldRes });
      if (state.undoStack.length > 50) state.undoStack.shift();

      state.results[mid] = {
        winner: winnerPick,
        scoreA: sA,
        scoreB: sB,
        score: `${sA}-${sB}`,
        updatedAt: new Date().toISOString()
      };
      syncState();
    }

    function undoLast() {
      if (state.undoStack.length === 0) return alert("Rien à annuler.");
      const action = state.undoStack.pop();
      if (action.prev === null) {
        delete state.results[action.matchId];
      } else {
        state.results[action.matchId] = action.prev;
      }
      syncState();
    }

    /* =========================================================================
       Firebase Syncing
       ========================================================================= */
    const fbRef = db.ref('v4State');

    function syncState() {
      fbPushSuppressed = true;
      fbRef.set(state).then(() => {
        setTimeout(() => fbPushSuppressed = false, 500);
      });
      // Local optimstic update
      rebuildEconomy();
      renderApp();
    }

    fbRef.on('value', snap => {
      const data = snap.val();
      if (data && !fbPushSuppressed) {
        // Ensure structure mapping
        state.results = data.results || {};
        state.bets = data.bets || {};
        state.undoStack = data.undoStack || [];
        rebuildEconomy();
        renderApp();
      }
    });

    /* =========================================================================
       UI RENDERERS
       ========================================================================= */
    const $ = id => document.getElementById(id);

    function renderMatchCard(m, context) {
      const res = state.results[m.id];
      const isFinished = !!res;
      const pot = getPotInfo(m.id);

      const myBet = state.bets[m.id]?.[sessionId];
      const hasBet = !!myBet;

      // Header
      let statusHTML = isFinished
        ? `<span class="text-green">Terminé (${res.format} - ${res.score || ''})</span>`
        : `<span class="text-red">En attente</span>`;

      // Players
      let winClassA = isFinished && res.winner === "A" ? "winner" : "";
      let winClassB = isFinished && res.winner === "B" ? "winner" : "";

      // Betting UI
      let betHTML = "";
      if (isFinished) {
        if (hasBet) {
          const won = myBet.pick === res.winner;
          betHTML = `<div class="bet-area" style="text-align:center;">
              <span class="${won ? 'text-green' : 'text-red'}">
                Résultat de votre pari: ${won ? 'Gagné !' : 'Perdu'} (${myBet.amount}© sur ${myBet.pick === "A" ? getPlayerName(m.a) : getPlayerName(m.b)})
              </span>
            </div>`;
        } else {
          betHTML = `<div class="bet-area" style="text-align:center; color:var(--text-muted)">Paris fermés (Cagnotte finale: ${pot.total}©)</div>`;
        }
      } else {
        // Open for bets
        let inputs = `
            <div class="flex-row">
              <select id="pick_${m.id}" class="input">
                <option value="A" ${myBet?.pick === 'A' ? 'selected' : ''}>${getPlayerName(m.a)}</option>
                <option value="B" ${myBet?.pick === 'B' ? 'selected' : ''}>${getPlayerName(m.b)}</option>
              </select>
              <input type="number" id="amt_${m.id}" class="input" placeholder="Mise" value="${myBet?.amount || ''}" style="width:100px;">
              <button class="btn btn-action" onclick="placeBet('${m.id}', $('pick_${m.id}').value, $('amt_${m.id}').value)">${hasBet ? 'Modifier' : 'Miser'}</button>
              ${hasBet ? `<button class="btn" style="background:transparent;border:none;" onclick="cancelBet('${m.id}')">❌</button>` : ''}
            </div>
         `;
        if (!sessionId) inputs = `<div class="text-red" style="font-size:12px;">Connectez-vous pour parier.</div>`;

        betHTML = `
           <div class="bet-area">
              <div class="bet-stats">
                <span>Cagnotte : <b class="text-green">${pot.total}©</b></span>
                <span>(A: ${pot.a} | B: ${pot.b})</span>
              </div>
              ${inputs}
           </div>
         `;
      }

      // Admin Controls (Visible if logged in, acting as global arbitrary ref)
      let adminHTML = "";
      if (sessionId && !isFinished) {
        adminHTML = `
           <div class="admin-actions" style="justify-content:center; align-items:center;">
             <span style="font-size:12px;color:var(--text-muted); text-transform:uppercase;">Score :</span>
             <input type="number" id="sa_${m.id}" class="input" value="0" min="0" max="3" style="width:60px; padding:4px; text-align:center; font-size:16px;">
             <span style="font-weight:bold; margin:0 5px;">-</span>
             <input type="number" id="sb_${m.id}" class="input" value="0" min="0" max="3" style="width:60px; padding:4px; text-align:center; font-size:16px;">
             <button class="btn" style="padding:6px 14px; font-size:12px; margin-left:15px;" onclick="resolveMatch('${m.id}', $('sa_${m.id}').value, $('sb_${m.id}').value)">Valider Score</button>
           </div>
         `;
      }

      return `
        <div class="match-card ${isFinished ? 'finished' : ''}">
          <div class="match-header">
            <span>Round ${m.round}</span>
            ${statusHTML}
          </div>
          
          <div class="match-versus">
            <div class="player ${winClassA}">${getPlayerName(m.a)}</div>
            <div class="vs-badge">VS</div>
            <div class="player ${winClassB}">${getPlayerName(m.b)}</div>
          </div>
          
          ${betHTML}
          ${adminHTML}
        </div>
      `;
    }

    function renderDashboard() {
      let fin = [], up = [];
      TOURNAMENT_MATCHES.forEach(m => {
        if (state.results[m.id]) fin.push(m);
        else up.push(m);
      });

      $('progCompleted').textContent = fin.length;
      $('progTotal').textContent = TOURNAMENT_MATCHES.length;

      // Next 6 matches
      $('dashUpcoming').innerHTML = up.slice(0, 6).map(m => renderMatchCard(m, 'dash')).join('') || "<p style='color:var(--text-muted)'>Aucun match programmé.</p>";

      // Last 3 finished
      let recent = fin.sort((a, b) => {
        const tA = new Date(state.results[a.id].updatedAt).getTime();
        const tB = new Date(state.results[b.id].updatedAt).getTime();
        return tB - tA;
      }).slice(0, 3);
      $('dashRecent').innerHTML = recent.map(m => renderMatchCard(m, 'dash')).join('') || "<p style='color:var(--text-muted)'>Aucun match terminé.</p>";
    }

    function renderMatchesTab() {
      const fRound = $('filterRound').value;
      let html = "";
      TOURNAMENT_MATCHES.forEach(m => {
        if (fRound === "all" || String(m.round) === fRound) {
          html += renderMatchCard(m, 'list');
        }
      });
      $('matchesContainer').innerHTML = html;
    }

    function renderStandings() {
      // 1. Players Standings (Wins)
      let pts = {}; PLAYERS.forEach(p => pts[p.id] = { id: p.id, name: p.name, w: 0, l: 0, pts: 0 });

      TOURNAMENT_MATCHES.forEach(m => {
        const res = state.results[m.id];
        if (!res) return;

        // Dynamically calculate points: 2-1 gives less points than 2-0.
        // Assuming base win gives 3 points (RULES.winPts). A close 2-1 gives 2 points.
        let matchWinPts = RULES.winPts;
        if (res.scoreA !== undefined && res.scoreB !== undefined) {
          if ((res.scoreA === 2 && res.scoreB === 1) || (res.scoreA === 1 && res.scoreB === 2)) {
            matchWinPts = 2;
          }
        } else if (res.score) {
          // Fallback for matches manually entered as "2-1" or "1-2" in older versions
          if (res.score === "2-1" || res.score === "1-2") matchWinPts = 2;
        }

        if (res.winner === "A") { pts[m.a].w++; pts[m.b].l++; pts[m.a].pts += matchWinPts; }
        if (res.winner === "B") { pts[m.b].w++; pts[m.a].l++; pts[m.b].pts += matchWinPts; }
      });

      let ranking = Object.values(pts).sort((a, b) => b.pts - a.pts || a.name.localeCompare(b.name));
      $('tableWins').innerHTML = ranking.map((p, i) => `
        <tr>
          <td class="rank-${i + 1}">${i + 1}</td>
          <td style="font-family:'Beaufort for LOL', serif;">${p.name}</td>
          <td>${p.w}</td>
          <td>${p.l}</td>
          <td class="text-green" style="font-weight:bold;">${p.pts}</td>
        </tr>
      `).join('');

      // 2. Bettors Standings
      let betsRanking = ALL_PROFILES.map(p => {
        const bal = ecoCache.balances[p.id] || 0;
        const stats = ecoCache.stats[p.id] || { bets: 0, wins: 0 };
        const wr = stats.bets > 0 ? Math.round((stats.wins / stats.bets) * 100) : 0;
        return { name: p.name, bal, wr };
      }).sort((a, b) => b.bal - a.bal || b.wr - a.wr);

      $('tableBets').innerHTML = betsRanking.map((p, i) => `
        <tr>
          <td class="rank-${i + 1}">${i + 1}</td>
          <td>${p.name}</td>
          <td style="color:var(--hex-gold-light); font-weight:bold;" class="mono">${p.bal} ©</td>
          <td>${p.wr}%</td>
        </tr>
      `).join('');
    }

    function renderApp() {
      if (!state.results) state.results = {}; // safe wrapper
      if (!ecoCache) rebuildEconomy();

      renderDashboard();
      renderMatchesTab();
      renderStandings();
    }

    /* =========================================================================
       NAVIGATION & INIT
       ========================================================================= */

    // Auth logic
    function setSession(id) {
      sessionId = id;
      if (id) localStorage.setItem("lol_planner_sess", id);
      else localStorage.removeItem("lol_planner_sess");

      if (id) {
        $('loginModal').classList.add('hidden');
        $('navUserName').textContent = getProfileName(id);
      } else {
        $('loginModal').classList.remove('hidden');
        $('navUserName').textContent = "-";
        $('navCredits').textContent = "0";
      }
      renderApp();
    }

    $('btnLogin').addEventListener('click', () => {
      const p = $('loginProfile').value;
      setSession(p);
    });

    $('btnLogOut').addEventListener('click', () => setSession(null));

    // Nav Logic
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        e.target.classList.add('active');
        $(e.target.dataset.target).classList.add('active');
        renderApp(); // re-render view
      });
    });

    $('filterRound').addEventListener('change', renderMatchesTab);

    // Admin Tools
    $('btnAdminUndo').addEventListener('click', undoLast);
    $('btnAdminRecalc').addEventListener('click', () => { rebuildEconomy(); renderApp(); alert("Economie recalculée."); });
    $('btnAdminReset').addEventListener('click', () => {
      if (!confirm("DANGER : Supprimer tous les matchs, paris et resets l'argent à 100 ?")) return;
      state.results = {};
      state.bets = {};
      state.undoStack = [];
      syncState();
    });

    // Boot
    window.onload = () => {
      // Build selects
      $('loginProfile').innerHTML = ALL_PROFILES.map(p => `<option value="${p.id}">${p.name}</option>`).join('');

      const roundsSet = new Set(TOURNAMENT_MATCHES.map(m => m.round));
      $('filterRound').innerHTML += Array.from(roundsSet).map(r => `<option value="${r}">Round ${r}</option>`).join('');

      // Auto login check
      setSession(sessionId);
    };

  </script>
</body>

</html>